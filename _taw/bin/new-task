#!/bin/bash

# TAW New Task Creator
# Creates a new task in .taw/agents directory

# Resolve symlinks (macOS compatible)
resolve_path() {
    local path="$1"
    while [ -L "$path" ]; do
        local dir="$(cd "$(dirname "$path")" && pwd)"
        path="$(readlink "$path")"
        [[ "$path" != /* ]] && path="$dir/$path"
    done
    echo "$(cd "$(dirname "$path")" && pwd)/$(basename "$path")"
}

# Get TAW_HOME from script location
SCRIPT_PATH="$(resolve_path "$0")"
TAW_HOME="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

PROJECT_DIR="$(pwd)"
TAW_DIR="$PROJECT_DIR/.taw"
AGENTS_DIR="$TAW_DIR/agents"
LOG_DIR="$TAW_DIR/.metadata/log"
LOG_FILE="$LOG_DIR/new-task.log"

# Check if .taw directory exists
if [ ! -d "$TAW_DIR" ]; then
    echo "Error: .taw directory not found."
    echo "Run 'taw' first to initialize the project."
    exit 1
fi

# Ensure directories exist
mkdir -p "$AGENTS_DIR"
mkdir -p "$LOG_DIR"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Debug output function (uses TAW_DEBUG env var from parent)
debug() {
    if [ "${TAW_DEBUG:-0}" = "1" ]; then
        echo "[DEBUG new-task] $*" >&2
    fi
}

# Create temp file for editing with hint
temp_file=$(mktemp)
trap "rm -f '$temp_file'" EXIT
debug "Created temp file: $temp_file"

# Add hint comment
cat > "$temp_file" << 'EOF'
# 에이전트에게 시킬 일 적고 저장

EOF

# Determine editor and options
editor="${EDITOR:-vim}"
debug "Using editor: $editor"

# If editor is vi/vim/nvim, start on line 3 in insert mode
editor_args=()
if [[ "$editor" =~ (^|/)n?vim?$ ]]; then
    editor_args+=("-c" "normal! 3G" "-c" "startinsert")
fi

# Open editor
debug "Opening editor..."
"$editor" "${editor_args[@]}" "$temp_file"
debug "Editor closed"

# Read task content, filtering out comment lines (starting with #)
task_content=$(grep -v '^[[:space:]]*#' "$temp_file")

# Check if content exists after filtering (ignore empty lines for this check)
if [ -z "$(echo "$task_content" | tr -d '[:space:]')" ]; then
    echo "No content written. Task cancelled."
    log "Task cancelled: no content"
    exit 1
fi

log "Task content received, calling Claude CLI (haiku)..."
debug "Task content: $task_content"

# Call Claude CLI to generate task name
prompt="Generate a task name (8-32 chars, lowercase, hyphens ok).
Format: verb-target (e.g., fix-auth-bug, add-dark-mode)
Output ONLY the name.

Task:
$task_content"

debug "Calling claude CLI to generate task name..."
if [ "${TAW_DEBUG:-0}" = "1" ]; then
    task_name=$(echo "$prompt" | claude --print --model haiku 2>&1 | tee /dev/stderr | tr -d '[:space:]')
else
    task_name=$(echo "$prompt" | claude --print --model haiku 2>/dev/null | tr -d '[:space:]')
fi
debug "Claude CLI returned: '$task_name'"

log "Generated task name: $task_name"

# Validate task name: 8-32 chars, lowercase letters, numbers, hyphens, no leading/trailing hyphens
if [[ ! "$task_name" =~ ^[a-z0-9][a-z0-9-]{6,30}[a-z0-9]$ ]]; then
    timestamp=$(date '+%y%m%d%H%M%S')
    echo "Warning: Generated task name '$task_name' is invalid. Using timestamp."
    log "Invalid task name, using fallback: task-$timestamp"
    task_name="task-$timestamp"
fi

# Ensure no duplicate
final_name="$task_name"
counter=1
while [ -d "$AGENTS_DIR/$final_name" ]; do
    final_name="${task_name}-${counter}"
    counter=$((counter + 1))
done

# Create agent directory and save task content
agent_dir="$AGENTS_DIR/$final_name"
debug "Creating agent directory: $agent_dir"
mkdir -p "$agent_dir"
echo "$task_content" > "$agent_dir/task"

echo "Task created: $agent_dir"
log "Task created: $final_name"

# Start the agent (handle-task creates window and runs claude)
debug "Calling handle-task: $agent_dir"
"$TAW_HOME/_taw/bin/handle-task" "$agent_dir"
debug "handle-task completed"
