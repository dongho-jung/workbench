#!/bin/bash

# TAW New Task Creator
# Creates a new task in .taw/agents directory

# Resolve symlinks (macOS compatible)
resolve_path() {
    local path="$1"
    while [ -L "$path" ]; do
        local dir="$(cd "$(dirname "$path")" && pwd)"
        path="$(readlink "$path")"
        [[ "$path" != /* ]] && path="$dir/$path"
    done
    echo "$(cd "$(dirname "$path")" && pwd)/$(basename "$path")"
}

# Get TAW_HOME from script location
SCRIPT_PATH="$(resolve_path "$0")"
TAW_HOME="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

PROJECT_DIR="$(pwd)"
TAW_DIR="$PROJECT_DIR/.taw"
AGENTS_DIR="$TAW_DIR/agents"
LOG_DIR="$TAW_DIR/.metadata/log"
LOG_FILE="$LOG_DIR/new-task.log"

# Check if .taw directory exists
if [ ! -d "$TAW_DIR" ]; then
    echo "Error: .taw directory not found."
    echo "Run 'taw' first to initialize the project."
    exit 1
fi

# Ensure directories exist
mkdir -p "$AGENTS_DIR"
mkdir -p "$LOG_DIR"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"
}

# Create temp file for editing with hint
temp_file=$(mktemp)
trap "rm -f '$temp_file'" EXIT

# Add hint comment
cat > "$temp_file" << 'EOF'
# 에이전트에게 시킬 일 적고 저장

EOF

# Determine editor and options
editor="${EDITOR:-vim}"

# If editor is vi/vim/nvim, start on line 3 in insert mode
editor_args=()
if [[ "$editor" =~ (^|/)n?vim?$ ]]; then
    editor_args+=("-c" "normal! 3G" "-c" "startinsert")
fi

# Open editor
"$editor" "${editor_args[@]}" "$temp_file"

# Read task content, filtering out comment lines (starting with #)
task_content=$(grep -v '^[[:space:]]*#' "$temp_file")

# Check if content exists after filtering (ignore empty lines for this check)
if [ -z "$(echo "$task_content" | tr -d '[:space:]')" ]; then
    echo "No content written. Task cancelled."
    log "Task cancelled: no content"
    exit 1
fi

log "Task content received, calling Claude CLI (haiku)..."

# Call Claude CLI to generate task name
prompt="Generate a task name (8-32 chars, lowercase, hyphens ok).
Format: verb-target (e.g., fix-auth-bug, add-dark-mode)
Output ONLY the name.

Task:
$task_content"

task_name=$(claude --print --model haiku "$prompt" 2>/dev/null | tr -d '[:space:]')

log "Generated task name: $task_name"

# Validate task name: 8-32 chars, lowercase letters, numbers, hyphens, no leading/trailing hyphens
if [[ ! "$task_name" =~ ^[a-z0-9][a-z0-9-]{6,30}[a-z0-9]$ ]]; then
    timestamp=$(date '+%y%m%d%H%M%S')
    echo "Warning: Generated task name '$task_name' is invalid. Using timestamp."
    log "Invalid task name, using fallback: task-$timestamp"
    task_name="task-$timestamp"
fi

# Atomic directory creation - mkdir (without -p) fails if directory exists
# This prevents race conditions when multiple tasks are created simultaneously
create_task_atomically() {
    local base_name="$1"
    local content="$2"
    local final_name="$base_name"
    local counter=1
    local max_attempts=100

    while [ $counter -le $max_attempts ]; do
        local agent_dir="$AGENTS_DIR/$final_name"
        # mkdir without -p fails if directory exists (atomic check-and-create)
        if mkdir "$agent_dir" 2>/dev/null; then
            echo "$content" > "$agent_dir/task"
            echo "$agent_dir"
            return 0
        fi
        # Directory exists, try next name
        final_name="${base_name}-${counter}"
        counter=$((counter + 1))
    done

    return 1
}

agent_dir=$(create_task_atomically "$task_name" "$task_content")

if [ -z "$agent_dir" ] || [ ! -d "$agent_dir" ]; then
    echo "Failed to create task directory after multiple attempts"
    log "Failed to create task directory for: $task_name"
    exit 1
fi

final_name=$(basename "$agent_dir")

echo "Task created: $agent_dir"
log "Task created: $final_name"

# Start the agent (handle-task creates window and runs claude)
"$TAW_HOME/_taw/bin/handle-task" "$agent_dir"
