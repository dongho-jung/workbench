#!/bin/bash

# TAW - Tmux + Agent + Worktree
# Initializes .taw directory and starts tmux session
# Works with or without git repository

set -e

# Parse arguments
TAW_DEBUG=0
while [[ $# -gt 0 ]]; do
    case "$1" in
        -d|--debug)
            TAW_DEBUG=1
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: taw [-d|--debug]"
            exit 1
            ;;
    esac
done

# Debug output function
debug() {
    if [ "$TAW_DEBUG" = "1" ]; then
        echo "[DEBUG] $*" >&2
    fi
}

# Resolve symlinks (macOS compatible)
resolve_path() {
    local path="$1"
    while [ -L "$path" ]; do
        local dir="$(cd "$(dirname "$path")" && pwd)"
        path="$(readlink "$path")"
        [[ "$path" != /* ]] && path="$dir/$path"
    done
    echo "$(cd "$(dirname "$path")" && pwd)/$(basename "$path")"
}

# Get the installation directory (where taw was installed from)
SCRIPT_PATH="$(resolve_path "$0")"
TAW_HOME="$(cd "$(dirname "$SCRIPT_PATH")/../.." && pwd)"

PROJECT_DIR="$(pwd)"
TAW_DIR="$PROJECT_DIR/.taw"
PROJECT_NAME="$(basename "$PROJECT_DIR")"

LOG_DIR="$TAW_DIR/.metadata/log"
LOG_FILE="$LOG_DIR/start.log"
AGENTS_DIR="$TAW_DIR/agents"
SESSION_NAME="$PROJECT_NAME"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

# Detect if current directory is a git repository root
# Sets IS_GIT_REPO=true/false
detect_git_repo() {
    IS_GIT_REPO=false

    local git_root
    git_root=$(git rev-parse --show-toplevel 2>/dev/null) || {
        echo "Not a git repository. Running in non-git mode."
        return 0
    }

    local current_real
    local git_root_real
    current_real=$(cd "$PROJECT_DIR" && pwd -P)
    git_root_real=$(cd "$git_root" && pwd -P)

    if [ "$current_real" != "$git_root_real" ]; then
        echo "Warning: Not at git repository root (root is: $git_root)"
        echo "Running in non-git mode."
        return 0
    fi

    IS_GIT_REPO=true
}

# Initialize .taw directory structure
init_taw_dir() {
    local is_new=false

    if [ ! -d "$TAW_DIR" ]; then
        is_new=true
        echo "Initializing .taw directory..."

        mkdir -p "$TAW_DIR"
        mkdir -p "$TAW_DIR/agents"
        mkdir -p "$TAW_DIR/.metadata/log"
    fi

    # Always update symlinks (fixes broken links after taw repo moved)
    rm -rf "$TAW_DIR/.claude" 2>/dev/null
    ln -s "$TAW_HOME/_taw/claude" "$TAW_DIR/.claude"

    rm -f "$TAW_DIR/new-task" 2>/dev/null
    ln -s "$TAW_HOME/_taw/bin/new-task" "$TAW_DIR/new-task"

    rm -f "$TAW_DIR/cleanup" 2>/dev/null
    ln -s "$TAW_HOME/_taw/bin/cleanup" "$TAW_DIR/cleanup"

    # Link appropriate global PROMPT based on git mode
    rm -f "$TAW_DIR/.global-prompt" 2>/dev/null
    if [ "$IS_GIT_REPO" = true ]; then
        ln -s "$TAW_HOME/_taw/PROMPT.md" "$TAW_DIR/.global-prompt"
        touch "$TAW_DIR/.is-git-repo"
    else
        ln -s "$TAW_HOME/_taw/PROMPT-nogit.md" "$TAW_DIR/.global-prompt"
        rm -f "$TAW_DIR/.is-git-repo" 2>/dev/null
    fi

    # Create project PROMPT.md if not exists
    if [ ! -f "$TAW_DIR/PROMPT.md" ]; then
        cat > "$TAW_DIR/PROMPT.md" << 'EOF'
# Project Prompt

Add project-specific instructions here.
EOF
    fi

    if [ "$is_new" = true ]; then
        echo "Initialized .taw directory."
    fi
}

# Add .taw to .gitignore if not already there
update_gitignore() {
    local gitignore="$PROJECT_DIR/.gitignore"

    # Check for any pattern that would ignore .taw
    # Patterns: .taw, .taw/, **/.taw, **/.taw/, /.taw, /.taw/
    is_taw_ignored() {
        [ -f "$gitignore" ] && grep -qE '^(\*\*/)?\.taw/?$|^/\.taw/?$' "$gitignore"
    }

    if ! is_taw_ignored; then
        if [ -f "$gitignore" ]; then
            echo ".taw" >> "$gitignore"
            echo "Added .taw to .gitignore"
        else
            echo ".taw" > "$gitignore"
            echo "Created .gitignore with .taw"
        fi
    fi
}

check_dependencies() {
    if ! command -v tmux &> /dev/null; then
        echo "tmux is not installed. Install: brew install tmux"
        exit 1
    fi
}

is_session_running() {
    tmux -L "taw-$SESSION_NAME" has-session -t "$SESSION_NAME" 2>/dev/null
}

tm() {
    tmux -L "taw-$SESSION_NAME" "$@"
}

cleanup() {
    log "Cleanup started"
    echo "Cleaning up..."
    log "Cleanup completed"
}

start_session() {
    check_dependencies

    # Create directories
    mkdir -p "$LOG_DIR"
    mkdir -p "$AGENTS_DIR"

    log "=== Session start ==="
    log "Project: $PROJECT_NAME"
    log "Directory: $PROJECT_DIR"
    log "TAW Directory: $TAW_DIR"

    # Clean up tab markers from previous session
    find "$AGENTS_DIR" -name ".tab-created" -delete 2>/dev/null

    echo "Starting session '$SESSION_NAME'..."

    # Cleanup on exit
    trap cleanup EXIT

    # Start tmux session with temporary window
    cd "$PROJECT_DIR"
    tm new-session -d -s "$SESSION_NAME" -n "_" -c "$PROJECT_DIR"
    log "Tmux session created: $SESSION_NAME"

    # Configure tmux session
    tm set -t "$SESSION_NAME" mouse on

    # Unbind all default keys and set minimal bindings
    tm unbind-key -a
    tm bind -n C-q detach
    tm bind -n C-n run-shell "tmux new-window -t '$SESSION_NAME' -n '_' -c '$PROJECT_DIR' '$TAW_HOME/_taw/bin/new-task'"
    # Pane: Alt + arrows to move, Alt + hjkl to split, Alt + x to close
    tm bind -n M-Left select-pane -L
    tm bind -n M-Right select-pane -R
    tm bind -n M-Up select-pane -U
    tm bind -n M-Down select-pane -D
    tm bind -n M-h split-window -hb -c "#{pane_current_path}"
    tm bind -n M-j split-window -v -c "#{pane_current_path}"
    tm bind -n M-k split-window -vb -c "#{pane_current_path}"
    tm bind -n M-l split-window -h -c "#{pane_current_path}"
    tm bind -n M-x kill-pane
    # Window: Ctrl+Alt + arrows (using Shift+Alt as fallback for compatibility)
    tm bind -n S-M-Left previous-window
    tm bind -n S-M-Right next-window
    # End task: Ctrl+E - send /done to agent pane (pane 0)
    # Sequence: Escape (exit multiline) -> Ctrl+C (cancel current) -> /done text -> Escape -> Enter
    tm bind -n C-e run-shell "tmux send-keys -t .0 Escape; sleep 0.3; tmux send-keys -t .0 C-c; sleep 0.5; tmux send-keys -t .0 -l '/done'; sleep 0.2; tmux send-keys -t .0 Escape; sleep 0.2; tmux send-keys -t .0 -H 0d"
    # Help: Alt+/ - show help in temporary window
    tm bind -n M-/ new-window -n "HELP" "less '$TAW_HOME/_taw/HELP.md'"
    log "Tmux configured"

    # Status line: 2 lines - windows on top, hints on bottom
    tm set -t "$SESSION_NAME" status 2
    tm set -t "$SESSION_NAME" status-format[0] "#[align=left]#{W:#[fg=white bg=default] #W #[default],#[fg=white bg=blue bold] #W #[default]}"
    tm set -t "$SESSION_NAME" status-format[1] "#[align=left fg=brightblack] ^n:new-task  ^e:end-task  ⌥←→↑↓:move-pane  ⌥hjkl:split-pane  ⌥x:close-pane  ⇧⌥←→:move-window  ^q:quit  ⌥/:help"

    # Run new-task in the initial window (will be killed after first task is created)
    debug "Running new-task in initial window..."
    tm send-keys -t "$SESSION_NAME:_" "$TAW_HOME/_taw/bin/new-task" Enter

    # Attach to session
    log "Attaching to session"
    printf '\e]1;%s\a' "taw: $SESSION_NAME"
    tm attach -t "$SESSION_NAME"

    # This runs after tmux exits
    cleanup
}

# === Main ===

# Check if already inside tmux session
if [ -n "$TMUX" ]; then
    echo "Already inside tmux session. Ignoring."
    exit 0
fi

# Detect git repo and initialize
debug "Detecting git repo..."
detect_git_repo
debug "IS_GIT_REPO=$IS_GIT_REPO"
debug "Initializing taw directory..."
init_taw_dir
debug "TAW_DIR=$TAW_DIR"
if [ "$IS_GIT_REPO" = true ]; then
    update_gitignore
fi

# Ensure log directory exists for reattach logging
mkdir -p "$LOG_DIR"

# Export TAW_HOME and TAW_DEBUG for child scripts
export TAW_HOME TAW_DEBUG

# If session exists, attach to it; otherwise start new
if is_session_running; then
    log "Reattaching to existing session: $SESSION_NAME"
    echo "Attaching to existing session '$SESSION_NAME'..."
    printf '\e]1;%s\a' "taw: $SESSION_NAME"
    tm attach -t "$SESSION_NAME"
else
    start_session
fi
