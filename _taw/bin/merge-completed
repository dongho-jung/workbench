#!/bin/bash

# TAW Merge Completed Tasks
# Merges and ends all tasks with ✅ status
# Called from Alt+m keybinding

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

TAW_HOME=$(get_taw_home)

# Arguments
SESSION_NAME="$1"

if [ -z "$SESSION_NAME" ]; then
    echo "Usage: merge-completed <session_name>"
    exit 1
fi

# Find project directory from session name (uses common function)
PROJECT_DIR=$(find_project_dir_from_session "$SESSION_NAME")
if [ -z "$PROJECT_DIR" ]; then
    echo "Could not find project directory for session: $SESSION_NAME"
    exit 1
fi
TAW_DIR="$PROJECT_DIR/.taw"
AGENTS_DIR="$TAW_DIR/agents"
LOG_FILE="$TAW_DIR/.metadata/log/merge-completed.log"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

log "=== Merge completed tasks ===" "$LOG_FILE"

# Check if this is git mode
IS_GIT_MODE=false
if [ -f "$TAW_DIR/.is-git-repo" ]; then
    IS_GIT_MODE=true
fi

if [ "$IS_GIT_MODE" = false ]; then
    log "Non-git mode, skipping" "$LOG_FILE"
    echo "Not a git repository. Merge is only available in git mode."
    exit 0
fi

# Get current branch in PROJECT_DIR (where we'll merge to)
MAIN_BRANCH=$(git -C "$PROJECT_DIR" branch --show-current 2>/dev/null)
if [ -z "$MAIN_BRANCH" ]; then
    log "Could not determine main branch" "$LOG_FILE"
    echo "Error: Could not determine current branch"
    exit 1
fi

log "Main branch: $MAIN_BRANCH" "$LOG_FILE"

# Find all windows with ✅ status
COMPLETED_WINDOWS=$(tm "$SESSION_NAME" list-windows -F "#{window_id}:#{window_name}" 2>/dev/null | grep "^@.*:✅" || true)

if [ -z "$COMPLETED_WINDOWS" ]; then
    log "No completed tasks found" "$LOG_FILE"
    echo "No completed tasks (✅) found."
    exit 0
fi

# Count completed tasks
COMPLETED_COUNT=$(echo "$COMPLETED_WINDOWS" | wc -l | tr -d ' ')
log "Found $COMPLETED_COUNT completed task(s)" "$LOG_FILE"

echo "Found $COMPLETED_COUNT completed task(s) to merge and end."
echo ""

# Process each completed task
MERGED_COUNT=0
FAILED_COUNT=0

while IFS=: read -r window_id window_name; do
    [ -z "$window_id" ] && continue

    # Extract task name (remove ✅ prefix)
    task_name=$(echo "$window_name" | sed 's/^✅//')

    echo "Processing: $task_name"
    log "Processing task: $task_name (window: $window_id)" "$LOG_FILE"

    # Check if branch exists
    if ! git -C "$PROJECT_DIR" rev-parse --verify "$task_name" &>/dev/null; then
        echo "  ⚠️  Branch '$task_name' not found, skipping merge"
        log "Branch not found: $task_name" "$LOG_FILE"
        # Still end the task
    else
        # Merge the branch
        echo "  Merging $task_name -> $MAIN_BRANCH..."
        if git -C "$PROJECT_DIR" merge "$task_name" --no-ff -m "Merge branch '$task_name'" 2>> "$LOG_FILE"; then
            echo "  ✓ Merged successfully"
            log "Merged successfully: $task_name" "$LOG_FILE"
            MERGED_COUNT=$((MERGED_COUNT + 1))
        else
            echo "  ✗ Merge failed (conflicts?)"
            log "Merge failed: $task_name" "$LOG_FILE"
            FAILED_COUNT=$((FAILED_COUNT + 1))
            # Abort the merge and continue with next task
            git -C "$PROJECT_DIR" merge --abort 2>/dev/null || true
            continue
        fi
    fi

    # End the task (cleanup)
    echo "  Cleaning up..."
    "$TAW_HOME/_taw/bin/end-task" "$SESSION_NAME" "$window_id" --force >> "$LOG_FILE" 2>&1 || true
    echo "  ✓ Task ended"
    log "Task ended: $task_name" "$LOG_FILE"

done <<< "$COMPLETED_WINDOWS"

echo ""
echo "=== Summary ==="
echo "Merged: $MERGED_COUNT"
echo "Failed: $FAILED_COUNT"
log "Summary: merged=$MERGED_COUNT, failed=$FAILED_COUNT" "$LOG_FILE"
