#!/bin/bash

# TAW Initial Setup
# Interactive configuration wizard for new projects

set -e

# Source common utilities
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
source "$SCRIPT_DIR/_common.sh"

# Arguments
TAW_DIR="${1:-}"
IS_GIT_REPO="${2:-false}"

if [ -z "$TAW_DIR" ]; then
    echo "Usage: setup <taw-directory> [is-git-repo]"
    exit 1
fi

CONFIG_FILE="$TAW_DIR/config"

# Colors (if terminal supports them)
if [ -t 1 ]; then
    BOLD='\033[1m'
    DIM='\033[2m'
    CYAN='\033[36m'
    GREEN='\033[32m'
    YELLOW='\033[33m'
    RESET='\033[0m'
else
    BOLD='' DIM='' CYAN='' GREEN='' YELLOW='' RESET=''
fi

print_header() {
    echo ""
    echo -e "${BOLD}${CYAN}=== TAW Initial Setup ===${RESET}"
    echo ""
}

print_option() {
    local num="$1"
    local label="$2"
    local desc="$3"
    local selected="${4:-false}"

    if [ "$selected" = "true" ]; then
        echo -e "  ${GREEN}â†’ ${num}) ${label}${RESET} ${DIM}${desc}${RESET}"
    else
        echo -e "    ${num}) ${label} ${DIM}${desc}${RESET}"
    fi
}

# Select work mode (git repos only)
select_work_mode() {
    echo -e "${BOLD}Work Mode${RESET}"
    echo -e "${DIM}How should taw create working directories for tasks?${RESET}"
    echo ""
    print_option "1" "worktree" "- Create git worktree per task (isolated, recommended)" "true"
    print_option "2" "main" "- Work directly on current branch (simpler)"
    echo ""

    while true; do
        read -p "Select [1-2, default: 1]: " choice
        case "${choice:-1}" in
            1) echo "worktree"; return ;;
            2) echo "main"; return ;;
            *) echo "Invalid choice. Please enter 1 or 2." >&2 ;;
        esac
    done
}

# Select on-complete behavior
select_on_complete() {
    echo -e "${BOLD}On Task Complete${RESET}"
    echo -e "${DIM}What should happen when a task is finished?${RESET}"
    echo ""
    print_option "1" "confirm" "- Ask before each action (safest)" "true"
    print_option "2" "auto-commit" "- Automatically commit changes"
    print_option "3" "auto-merge" "- Auto commit + merge to main"
    print_option "4" "auto-pr" "- Auto commit + create PR (recommended for teams)"
    echo ""

    while true; do
        read -p "Select [1-4, default: 1]: " choice
        case "${choice:-1}" in
            1) echo "confirm"; return ;;
            2) echo "auto-commit"; return ;;
            3) echo "auto-merge"; return ;;
            4) echo "auto-pr"; return ;;
            *) echo "Invalid choice. Please enter 1-4." >&2 ;;
        esac
    done
}

# Generate config file with comments
generate_config() {
    local work_mode="$1"
    local on_complete="$2"

    cat > "$CONFIG_FILE" << EOF
# TAW Configuration
# Edit this file directly to change settings
# Documentation: https://github.com/user/taw#configuration

# ============================================================================
# Work Mode (git repositories only)
# ============================================================================
# How taw creates working directories for each task
#
# Options:
#   worktree  - Create a git worktree per task (recommended)
#               Each task gets isolated branch, changes don't affect main
#   main      - Work directly on current branch
#               Simpler but changes are immediately visible
#
work_mode: $work_mode

# ============================================================================
# On Complete Behavior
# ============================================================================
# What happens when /finish is called or task completes
#
# Options:
#   confirm     - Ask before each action (commit, merge, PR)
#   auto-commit - Automatically commit changes (manual merge/PR)
#   auto-merge  - Auto commit + merge to current branch
#   auto-pr     - Auto commit + create Pull Request (for teams)
#
on_complete: $on_complete

# ============================================================================
# Future Settings (not yet implemented)
# ============================================================================
#
# auto_test: true           # Run tests before commit
# branch_prefix: "taw/"     # Prefix for task branches
# default_model: "sonnet"   # Claude model for tasks
#
EOF
}

# Main setup flow
main() {
    print_header

    # Check if config already exists
    if [ -f "$CONFIG_FILE" ]; then
        echo -e "${YELLOW}Configuration already exists at: $CONFIG_FILE${RESET}"
        read -p "Reconfigure? [y/N]: " reconfigure
        if [[ ! "$reconfigure" =~ ^[Yy]$ ]]; then
            echo "Keeping existing configuration."
            return 0
        fi
        echo ""
    fi

    # Collect settings
    local work_mode="$DEFAULT_WORK_MODE"
    local on_complete="$DEFAULT_ON_COMPLETE"

    # Only ask about work mode for git repos
    if [ "$IS_GIT_REPO" = "true" ]; then
        work_mode=$(select_work_mode)
        echo ""
    else
        echo -e "${DIM}Non-git repository detected. Work mode: main (fixed)${RESET}"
        work_mode="main"
        echo ""
    fi

    on_complete=$(select_on_complete)
    echo ""

    # Generate config
    generate_config "$work_mode" "$on_complete"

    echo -e "${GREEN}Configuration saved to: $CONFIG_FILE${RESET}"
    echo -e "${DIM}You can edit this file directly to change settings.${RESET}"
    echo ""
}

# Run main
main
