#!/bin/bash

# Toggle help popup window
# If help is open, close it. If closed, open it.
# Uses tmux user option for reliable state tracking (same pattern as popup-shell)

set -e

SESSION_NAME="${1:-}"
if [ -z "$SESSION_NAME" ]; then
    echo "Usage: toggle-help SESSION_NAME" >&2
    exit 1
fi

# Resolve TAW_HOME if not set
if [ -z "$TAW_HOME" ]; then
    SCRIPT_PATH="$(cd "$(dirname "$0")" && pwd)"
    TAW_HOME="$(cd "$SCRIPT_PATH/../.." && pwd)"
fi

# tmux helper
tm() {
    tmux -L "taw-$SESSION_NAME" "$@"
}

# Check if help popup is currently open (using tmux user option)
HELP_OPEN=$(tm show-options -gqv @taw_help_open 2>/dev/null || echo "")

if [ "$HELP_OPEN" = "1" ]; then
    # Help is currently shown - close it
    # Note: display-popup -C only works from inside the popup
    # Opening a new popup that immediately exits will close the existing one
    tm set-option -g @taw_help_open ""
    tm display-popup -E "true" 2>/dev/null || true
else
    # Help is not shown - open it
    tm set-option -g @taw_help_open "1"
    # When less exits (user presses q or popup is closed), clean up the state
    tm display-popup -E -w 80% -h 80% -T " Help (âŒ¥/ to close) " \
        "less '$TAW_HOME/_taw/HELP.md'; tmux -L 'taw-$SESSION_NAME' set-option -g @taw_help_open '' 2>/dev/null || true"
fi
