#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECTS_DIR="$SCRIPT_DIR/projects"

if [ ! -d "$PROJECTS_DIR" ]; then
    echo "No projects directory found."
    exit 1
fi

# Check if any projects exist
if [ -z "$(ls -A "$PROJECTS_DIR" 2>/dev/null)" ]; then
    echo "No projects found."
    exit 1
fi

# Open yazi to select a project (depth 1 only)
temp_file=$(mktemp)
yazi --chooser-file="$temp_file" "$PROJECTS_DIR"

if [ ! -s "$temp_file" ]; then
    rm -f "$temp_file"
    echo "No project selected."
    exit 1
fi

selected_path=$(cat "$temp_file")
rm -f "$temp_file"

# Validate selection is directly under projects/
project_name=$(basename "$selected_path")
expected_path="$PROJECTS_DIR/$project_name"

if [ "$selected_path" != "$expected_path" ]; then
    echo "Please select a project directly under projects/"
    exit 1
fi

if [ ! -d "$selected_path" ]; then
    echo "Selected path is not a directory."
    exit 1
fi

echo "Deleting project: $project_name"
echo ""

# 1. Kill tmux session if running
if tmux has-session -t "$project_name" 2>/dev/null; then
    echo "Killing tmux session '$project_name'..."
    tmux kill-session -t "$project_name"
fi

# 2. Kill fswatch processes for this project
echo "Stopping file watchers..."
pkill -f "fswatch.*$selected_path/agents" 2>/dev/null || true

# 3. Get the actual repo location
location_link="$selected_path/location"
if [ -L "$location_link" ]; then
    repo_path=$(readlink "$location_link")

    # 4. Remove all worktrees for this project (agents/{task-name} is the worktree itself)
    echo "Removing worktrees..."
    if [ -d "$selected_path/agents" ]; then
        for agent_dir in "$selected_path/agents"/*/; do
            if [ -d "$agent_dir" ]; then
                # Check if it's a git worktree
                if [ -f "${agent_dir}.git" ]; then
                    echo "  Removing worktree: $agent_dir"
                    git -C "$repo_path" worktree remove "$agent_dir" --force 2>/dev/null || true
                fi
            fi
        done
    fi

    # Prune stale worktrees
    git -C "$repo_path" worktree prune 2>/dev/null || true

    # 5. Delete branches created for tasks
    echo "Removing task branches..."
    if [ -d "$selected_path/agents" ]; then
        for agent_dir in "$selected_path/agents"/*/; do
            task_name=$(basename "$agent_dir")
            if [ -n "$task_name" ] && [ "$task_name" != "*" ]; then
                if git -C "$repo_path" branch --list "$task_name" | grep -q "$task_name"; then
                    echo "  Deleting branch: $task_name"
                    git -C "$repo_path" branch -D "$task_name" 2>/dev/null || true
                fi
            fi
        done
    fi
fi

# 6. Make project dir writable and remove it
chmod +w "$selected_path" 2>/dev/null || true
echo "Removing project directory..."
rm -rf "$selected_path"

echo ""
echo "Project '$project_name' deleted."
